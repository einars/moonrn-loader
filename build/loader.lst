# file opened: src/loader.asm
  1   0000                              device zxspectrum128
  2   0000
  3   0000                              org 0x5ccb
  4   5CCB
  5   5CCB              basic_start equ $
  6   5CCB
  7   5CCB              B_RANDOMIZE equ 0f9h
  8   5CCB              B_USR equ 0c0h
  9   5CCB
 10   5CCB
 11   5CCB              target_code_start equ 32768
 12   5CCB
 13   5CCB                              lua
 14   5CCB ~                            local f
 15   5CCB ~
 16   5CCB ~                            f = io.open("./pristine/moonrn.bin")
 17   5CCB ~                            sj.insert_define("target_code_len", f:seek("end"))
 18   5CCB ~                            f:close()
 19   5CCB ~
 20   5CCB ~                            f = io.open("./build/code.pck")
 21   5CCB ~                            sj.insert_define("packed_code_len", f:seek("end"))
 22   5CCB ~                            f:close()
 23   5CCB ~
 24   5CCB                              endlua
 25   5CCB
 26   5CCB              line10:
 27   5CCB 00 0A                        db 0, 10
 28   5CCD E4 04                        dw End - .cmds
 29   5CCF              .cmds
 30   5CCF F9 C0 31 0E                  db B_RANDOMIZE, B_USR, "1", 14, 0, 0
 30   5CD3 00 00
 31   5CD5 D9 5C                        dw Start
 32   5CD7 00 3A                        db 0, ':'
 33   5CD9
 34   5CD9              Start:
 35   5CD9 31 FF FF                     ld sp, 65535
 36   5CDC AF                           xor a
 37   5CDD FD 77 0E                     ld (iy+14), a
 38   5CE0 D3 FE                        out (254), a
 39   5CE2 21 B2 61                     ld  hl, Image_end ; reverse unpacking
 40   5CE5 11 FF 5A                     ld  de, 0x4000+6912 - 1
 41   5CE8
 42   5CE8 CD 19 5D                     call ue2_unpack
 43   5CEB
 44   5CEB              loader_base equ 65000
 45   5CEB                              ; relocate calls to ld_edge_*
 46   5CEB 21 63 FE                     ld hl, ld_edge_1 - load + loader_base
 47   5CEE 22 B9 5D                     ld (rel1), hl
 48   5CF1
 49   5CF1 21 5F FE                     ld hl, ld_edge_2 - load + loader_base
 50   5CF4 22 A6 5D                     ld (rel2), hl
 51   5CF7
 52   5CF7 21 41 5D                     ld hl, loader_start
 53   5CFA 11 E8 FD                     ld de, loader_base
 54   5CFD 01 81 01                     ld bc, loader_end - loader_start
 55   5D00 ED B0                        ldir
 56   5D02
 57   5D02
 58   5D02                              ; di
 59   5D02                              ; halt
 60   5D02
 61   5D02
 62   5D02 DD 21 C2 5E                  ld ix, packed_code_start
 63   5D06 11 42 45                     ld de, 17730
 64   5D09 3E FF                        ld a, 255
 65   5D0B 37                           scf
 66   5D0C
 67   5D0C                              ;call 0556h
 68   5D0C CD E8 FD                     call loader_base
 69   5D0F
 70   5D0F 21 00 80                     ld hl, target_code_start
 71   5D12 E5                           push hl
 72   5D13 11 A7 D7                     ld de, target_code_start + 22440 - 1
 73   5D16 21 03 A4                     ld hl, packed_code_start + 17730 - 1
 74   5D19
 75   5D19
 76   5D19              ue2_unpack:
 77   5D19 3E 80                        ld a, 128
 78   5D1B
 79   5D1B 01 01 00     MainLoop        ld bc,1
 80   5D1E CD 3B 5D                     call ReadBit                         ; Literal?
 81   5D21 38 10                        jr c,CopyBytes
 82   5D23
 83   5D23 CD 3B 5D     EliasGamma      call ReadBit
 84   5D26 CB 11                        rl c
 85   5D28 D8                           ret  c                               ; Option to include the end of stream marker.
 86   5D29 CD 3B 5D                     call ReadBit
 87   5D2C 38 F5                        jr c,EliasGamma
 88   5D2E
 89   5D2E E5                           push hl
 90   5D2F 6E                           ld l,(hl)
 91   5D30 60                           ld h,b
 92   5D31 19                           add hl,de
 93   5D32 23                           inc hl
 94   5D33 ED B8        CopyBytes       lddr
 95   5D35 38 E4                        jr c,MainLoop
 96   5D37 E1                           pop hl
 97   5D38 2B                           dec hl
 98   5D39 18 E0                        jr MainLoop
 99   5D3B
100   5D3B 87           ReadBit         add a,a
101   5D3C C0                           ret nz
102   5D3D 7E                           ld a,(hl)
103   5D3E 2B                           dec hl
104   5D3F 17                           rla
105   5D40 C9                           ret
106   5D41
107   5D41              loader_start:
108   5D41                              include "src/fuckerding.inc"
# file opened: ./src/fuckerding.inc
  1+  5D41              effect_delay equ 6
  2+  5D41
  3+  5D41              load:
  4+  5D41 D9                           exx
  5+  5D42 21 AD FE                     ld hl, lines_reloc
  6+  5D45 06 06                        ld b, effect_delay
  7+  5D47 0E 06                        ld c, effect_delay
  8+  5D49 D9                           exx
  9+  5D4A
 10+  5D4A 14                           inc d
 11+  5D4B 08                           ex af, af
 12+  5D4C 15                           dec d
 13+  5D4D F3                           di
 14+  5D4E DB FE                        in a, (254)
 15+  5D50 1F                           rra
 16+  5D51 E6 20                        and 0x20
 17+  5D53 F6 02                        or 2
 18+  5D55 4F                           ld c, a
 19+  5D56 BF                           cp a
 20+  5D57
 21+  5D57 C0           ld_break        ret nz
 22+  5D58              ld_start
 23+  5D58 CD E7 05                     call rom_ld_edge_1
 24+  5D5B 30 FA                        jr nc, ld_break
 25+  5D5D
 26+  5D5D 21 15 04                     ld hl, 0x415
 27+  5D60 10 FE        ld_wait         djnz ld_wait
 28+  5D62 2B                           dec hl
 29+  5D63 7C                           ld a, h
 30+  5D64 B5                           or l
 31+  5D65 20 F9                        jr nz, ld_wait
 32+  5D67
 33+  5D67 CD E3 05                     call rom_ld_edge_2
 34+  5D6A 30 EB                        jr nc, ld_break
 35+  5D6C
 36+  5D6C              ld_leader
 37+  5D6C 06 9C                        ld b, 0x9c
 38+  5D6E CD E3 05                     call rom_ld_edge_2
 39+  5D71 30 E4                        jr nc, ld_break
 40+  5D73
 41+  5D73 3E C6                        ld a, 0xc6
 42+  5D75 B8                           cp b
 43+  5D76 30 E0                        jr nc, ld_start
 44+  5D78
 45+  5D78 24                           inc h
 46+  5D79 20 F1                        jr nz, ld_leader
 47+  5D7B
 48+  5D7B
 49+  5D7B 06 C9        ld_sync         ld b, 0xc9
 50+  5D7D CD E7 05                     call rom_ld_edge_1
 51+  5D80 30 D5                        jr nc, ld_break
 52+  5D82
 53+  5D82 78                           ld a, b
 54+  5D83 FE D4                        cp 0xd4
 55+  5D85 30 F4                        jr nc, ld_sync
 56+  5D87 CD E7 05                     call rom_ld_edge_1
 57+  5D8A D0                           ret nc
 58+  5D8B
 59+  5D8B                              ; use black screen, as the rom routines mangled it
 60+  5D8B AF                           xor a
 61+  5D8C D3 FE                        out (254), a
 62+  5D8E
 63+  5D8E 06 B0                        ld b, 0xb0
 64+  5D90
 65+  5D90 18 11                        jr ld_marker
 66+  5D92
 67+  5D92 08           ld_loop         ex af, af
 68+  5D93 20 05                        jr nz, ld_flag
 69+  5D95
 70+  5D95 DD 75 00                     ld (ix), l
 71+  5D98 18 03                        jr ld_next
 72+  5D9A
 73+  5D9A              ld_flag
 74+  5D9A                              ; handle flag without any checking
 75+  5D9A AF                           xor a  ; af' = Z, flag checked
 76+  5D9B 18 03                        jr 2f
 77+  5D9D
 78+  5D9D              ld_next
 79+  5D9D DD 23                        inc ix
 80+  5D9F 1B           ld_dec          dec de
 81+  5DA0              2
 82+  5DA0 08                           ex af, af
 83+  5DA1
 84+  5DA1 06 B2                        ld b, 0xb2
 85+  5DA3 2E 01        ld_marker       ld l, 1
 86+  5DA5              ld_8_bits
 87+  5DA5 CD B8 5D     rel2+*          call ld_edge_2
 88+  5DA8 D0                           ret nc
 89+  5DA9 3E C5                        ld a, 0xc5
 90+  5DAB B8                           cp b
 91+  5DAC CB 15                        rl l
 92+  5DAE 06 B0                        ld b, 0xb0
 93+  5DB0 D2 A5 5D                     jp nc, ld_8_bits
 94+  5DB3
 95+  5DB3 7A                           ld a, d
 96+  5DB4 B3                           or e
 97+  5DB5 20 DB                        jr nz, ld_loop
 98+  5DB7
 99+  5DB7 C9                           ret
100+  5DB8
101+  5DB8              rom_ld_edge_2 equ 0x5e3
102+  5DB8              rom_ld_edge_1 equ 0x5e7
103+  5DB8
104+  5DB8              ld_edge_2
105+  5DB8 CD BC 5D     rel1+*:         call ld_edge_1
106+  5DBB D0                           ret nc
107+  5DBC              ;breakpoint equ $-load + loader_base
108+  5DBC              ld_edge_1
109+  5DBC D9                           exx
110+  5DBD 00                           nop
111+  5DBE
112+  5DBE 05                           dec b           ; 4
113+  5DBF 28 08                        jr z, do_effect ;12/7 jump = +16
114+  5DC1
115+  5DC1                              ; 4 + 7 + extra jr 12 = 23
116+  5DC1
117+  5DC1 00                           nop
118+  5DC2 00                           nop
119+  5DC3                              ; =31
120+  5DC3
121+  5DC3 00                           nop
122+  5DC4 D9                           exx  ; exx nop nop exx = 16
123+  5DC5 3E 13                        ld a, 0x16 - 1 - 2
124+  5DC7 18 22                        jr spin
125+  5DC9
126+  5DC9              do_effect       ; + 16 from above
127+  5DC9
128+  5DC9 41                           ld b, c         ; 4 ; timing constant
129+  5DCA
130+  5DCA                              ; 20 so far
131+  5DCA
132+  5DCA 5E                           ld e, (hl)      ; 7
133+  5DCB 23                           inc hl          ; 6
134+  5DCC 56                           ld d, (hl)      ; 7
135+  5DCD 23                           inc hl          ; 6
136+  5DCE EB                           ex de, hl       ; 4
137+  5DCF CB 06                        rlc (hl)         ; 15 ; contended memory thou
138+  5DD1 EB                           ex de, hl       ; 4
139+  5DD2                              ; 53
140+  5DD2
141+  5DD2
142+  5DD2 5E                           ld e, (hl)      ; 7
143+  5DD3 23                           inc hl          ; 6
144+  5DD4 56                           ld d, (hl)      ; 7
145+  5DD5 23                           inc hl          ; 6
146+  5DD6 EB                           ex de, hl       ; 4
147+  5DD7 CB 0E                        rrc (hl)         ; 15 ; contended memory thou
148+  5DD9 EB                           ex de, hl       ; 4
149+  5DDA                              ; 53
150+  5DDA
151+  5DDA
152+  5DDA AF                           xor a
153+  5DDB B2                           or d            ; 4
154+  5DDC                              ; -- 126
155+  5DDC
156+  5DDC                              ; adjusted: 12+7+10 = 29 either way
157+  5DDC 20 03                        jr nz, ok    ; 12/7
158+  5DDE 21 AD FE                     ld hl, lines_reloc ; 10
159+  5DE1 28 03        ok:             jr z, adj    ; 12/7 symmetric branch timing adjustment
160+  5DE3 11 AD FE                     ld de, lines_reloc ; 10
161+  5DE6              adj:
162+  5DE6                              ; -- + 29 = 155
163+  5DE6 00                           nop
164+  5DE7                              ; 159, ~16*10
165+  5DE7
166+  5DE7 00                           nop
167+  5DE8 D9                           exx  ; exx nop nop exx = 16
168+  5DE9
169+  5DE9 3E 0B                        ld a, 0x16 - 1 - 10
170+  5DEB
171+  5DEB 3D           spin:           dec a           ; ~358 T
172+  5DEC 20 FD                        jr nz, spin     ; 1 dec-loop = 16T
173+  5DEE A7                           and a
174+  5DEF
175+  5DEF 04           ld_sample       inc b
176+  5DF0 C8                           ret z
177+  5DF1
178+  5DF1 3E 7F                        ld a, 0x7f
179+  5DF3 DB FE                        in a, (0xfe)
180+  5DF5 1F                           rra
181+  5DF6 D0                           ret nc
182+  5DF7
183+  5DF7 A9                           xor c
184+  5DF8 E6 20                        and 0x20
185+  5DFA 28 F3                        jr z, ld_sample
186+  5DFC
187+  5DFC 79                           ld a, c
188+  5DFD 2F                           cpl
189+  5DFE 4F                           ld c, a
190+  5DFF
191+  5DFF                              ;and 7 ; 4
192+  5DFF                              ;or 8 ; 4
193+  5DFF                              ;out (0xfe), a ; 11
194+  5DFF
195+  5DFF 00                           nop
196+  5E00 00                           nop
197+  5E01 00                           nop
198+  5E02 00                           nop
199+  5E03 00                           nop
200+  5E04
201+  5E04 37                           scf
202+  5E05 C9                           ret
203+  5E06
204+  5E06              lines_reloc equ $ - load + loader_base
205+  5E06              lines:
206+  5E06                              lua allpass
207+  5E06 ~                            local line1 = 0x49e0
208+  5E06 ~                            local line2 = line1 + 512
209+  5E06 ~                            local line3 = line2 + 512
210+  5E06 ~
211+  5E06 ~                            sj.add_word(line2 + 16)
212+  5E06 ~                            sj.add_word(line3 + 16)
213+  5E06 ~
214+  5E06 ~                            for i = 1, 15, 1
215+  5E06 ~                            do
216+  5E06 ~                              sj.add_word(line1 + 16 - i)
217+  5E06 ~                              sj.add_word(line1 + 16 + i)
218+  5E06 ~                              sj.add_word(line2 + 16 - i)
219+  5E06 ~                              sj.add_word(line2 + 16 + i)
220+  5E06 ~                              sj.add_word(line3 + 16 - i)
221+  5E06 ~                              sj.add_word(line3 + 16 + i)
222+  5E06 ~                            end
223+  5E06 F0 4B F0 4D                  endlua
223+  5E0A EF 49 F1 49
223+  5E0E EF 4B F1 4B
223+  5E12 EF 4D F1 4D
223+  5E16 EE 49 F2 49
223+  5E1A EE 4B F2 4B
223+  5E1E EE 4D F2 4D
223+  5E22 ED 49 F3 49
223+  5E26 ED 4B F3 4B
223+  5E2A ED 4D F3 4D
223+  5E2E EC 49 F4 49
223+  5E32 EC 4B F4 4B
223+  5E36 EC 4D F4 4D
223+  5E3A EB 49 F5 49
223+  5E3E EB 4B F5 4B
223+  5E42 EB 4D F5 4D
223+  5E46 EA 49 F6 49
223+  5E4A EA 4B F6 4B
223+  5E4E EA 4D F6 4D
223+  5E52 E9 49 F7 49
223+  5E56 E9 4B F7 4B
223+  5E5A E9 4D F7 4D
223+  5E5E E8 49 F8 49
223+  5E62 E8 4B F8 4B
223+  5E66 E8 4D F8 4D
223+  5E6A E7 49 F9 49
223+  5E6E E7 4B F9 4B
223+  5E72 E7 4D F9 4D
223+  5E76 E6 49 FA 49
223+  5E7A E6 4B FA 4B
223+  5E7E E6 4D FA 4D
223+  5E82 E5 49 FB 49
223+  5E86 E5 4B FB 4B
223+  5E8A E5 4D FB 4D
223+  5E8E E4 49 FC 49
223+  5E92 E4 4B FC 4B
223+  5E96 E4 4D FC 4D
223+  5E9A E3 49 FD 49
223+  5E9E E3 4B FD 4B
223+  5EA2 E3 4D FD 4D
223+  5EA6 E2 49 FE 49
223+  5EAA E2 4B FE 4B
223+  5EAE E2 4D FE 4D
223+  5EB2 E1 49 FF 49
223+  5EB6 E1 4B FF 4B
223+  5EBA E1 4D FF 4D
224+  5EBE 00 00                        dw 0
225+  5EC0 00 00                        dw 0
226+  5EC2
227+  5EC2
228+  5EC2
# file closed: ./src/fuckerding.inc
109   5EC2              loader_end equ $
110   5EC2
111   5EC2              packed_code_start:
112   5EC2                              incbin "build/loading.pck"
113   61B3              Image_end equ $-1
114   61B3
115   61B3              End equ $
116   61B3
117   61B3                  display "Saving moo.tap"
118   61B3                  emptytap "moo.tap"
119   61B3                  savetap  "moo.tap", basic, "MoonRn", basic_start, End - basic_start, 10
120   61B3                  tapout "moo.tap"
121   61B3                  incbin "build/code.pck"
122   A6F5                  tapend
123   A6F5
# file closed: src/loader.asm
